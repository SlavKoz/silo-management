declare @opt nvarchar = '';
declare @contract nvarchar = '';
declare @monthend nvarchar = '';
declare @membcode nvarchar = '';




SELECT 
    p.[Regraded Commodity] AS Commodity,
    p.Regrade AS GrainGroup,
    SUM(p.[Qty_ Stored]) AS [Nett Tonnes],
    p.[Address Block],
    tv.[SalesValue],
    tvb.[SoldPc],
    p.[Address],
    p.[Address 2],
    p.[City],
    p.[County],
    p.[Post Code],
    p.[Principle Contact],
    p.[Principle Contact Name],
    p.[Pool Name]

FROM (
    SELECT
        m.[Principle Contact],
        m.[Principle Contact Name],
        m.[Pool Name],
        m.[Qty_ Stored],
        m.[Address],
        m.[Address 2],
        m.[City],
        m.[County],
        m.[Post Code],
        m.[movement no_],
        m.[Item No],
        TRY_CAST(m.[moist %] AS float) AS Moist,
        TRY_CAST(m.[spec weight] AS float) AS SpecWeight,
        TRY_CAST(m.[p/o/n] AS float) AS PON,
        TRY_CAST(m.[hag/bru/germ] AS float) AS HAG,
        m.[Commodity],
        m.[Crop Year],
        m.[Pool Dimension],

        -- Regrade + Regraded Commodity from FUNCTION
        rg.Regrade,
        rg.RegradedCommodity AS [Regraded Commodity],

        -- Same Address Block builde
        CASE WHEN LEN(ISNULL(m.[Address],'')) > 0 
             THEN ISNULL(m.[Address],'') + CHAR(13) + CHAR(10) ELSE '' END +
        CASE WHEN LEN(ISNULL(m.[Address 2],'')) > 0 
             THEN ISNULL(m.[Address 2],'') + CHAR(13) + CHAR(10) ELSE '' END +
        CASE WHEN LEN(ISNULL(m.[City],'')) > 0 
             THEN ISNULL(m.[City],'') + CHAR(13) + CHAR(10) ELSE '' END +
        CASE WHEN LEN(ISNULL(m.[County],'')) > 0 
             THEN ISNULL(m.[County],'') + CHAR(13) + CHAR(10) ELSE '' END +
        CASE WHEN LEN(ISNULL(m.[Post Code],'')) > 0 
             THEN ISNULL(m.[Post Code],'') ELSE '' END AS [Address Block]

    FROM [Query].[dbo].[vw_Ops_Weighbridge_Movements_With_Subs] m

    CROSS APPLY [Query].dbo.f_Regrade(
        m.[Crop Year],
        m.Commodity,
        m.[Item No],
        TRY_CAST(m.[p/o/n] AS float),
        TRY_CAST(m.[hag/bru/germ] AS float),
        TRY_CAST(m.[moist %] AS float),
        TRY_CAST(m.[spec weight] AS float)
    ) rg

    WHERE
        m.[Pool Name] LIKE 'STO%'
        AND m.[contract type] LIKE '%member intake'
        AND m.[Contract No_] IN (@contract)
        AND m.[Ticket Date] <= @monthend
) p

LEFT JOIN [Query].[dbo].[vw_Ops_Tax_Valuations_Latest] tv
    ON tv.[Grain Group]      COLLATE Latin1_General_CI_AS = p.Regrade
    AND tv.[Pool]            COLLATE Latin1_General_CI_AS = p.[Pool Dimension]
    AND tv.[Commodity]       COLLATE Latin1_General_CI_AS = p.[Regraded Commodity]
    AND ISNUMERIC(p.[Crop Year]) = 1
    AND tv.[Crop Year]       COLLATE Latin1_General_CI_AS = p.[Crop Year]

LEFT JOIN [Query].[dbo].[tbl_Ops_Tax_Valuations] tvb
    ON tvb.[Grain Group]      COLLATE Latin1_General_CI_AS = p.Regrade
    AND tvb.[Pool]            COLLATE Latin1_General_CI_AS = p.[Pool Dimension]
    AND tvb.[Commodity]       COLLATE Latin1_General_CI_AS = p.[Regraded Commodity]
    AND ISNUMERIC(p.[Crop Year]) = 1
    AND tvb.MonthEnd = @monthend
    AND tvb.[Crop Year]       COLLATE Latin1_General_CI_AS = p.[Crop Year]



WHERE 
    p.[Principle Contact] = @membcode
    AND p.[Pool Dimension] IN (@opt)

GROUP BY
    p.[Principle Contact],
    p.[Principle Contact Name],
    p.[Regraded Commodity],
    p.Regrade,
    p.[Pool Name],
    tv.[SalesValue],
    tvb.[SoldPc],
    p.[Address],
    p.[Address 2],
    p.[City],
    p.[County],
    p.[Post Code],
    p.[Crop Year],
    p.[Address Block],
    p.[Pool Name];