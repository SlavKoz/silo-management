USE [query]
GO

/****** Object:  UserDefinedFunction [dbo].[f_Regrade]    Script Date: 26/11/2025 12:39:44 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE FUNCTION [dbo].[f_Regrade]
(
    @CropYear        INT,
    @Commodity       NVARCHAR(100),
    @Variety         NVARCHAR(100),   -- Item No / Variety
    @PON             FLOAT,
    @HAG             FLOAT,
    @Moist           FLOAT,
    @SpecWeight      FLOAT
)
RETURNS TABLE
AS
RETURN
WITH adj AS (
    SELECT 
        CASE 
            WHEN @Commodity LIKE '%Wheat%' AND @Moist >= 16
            THEN ((@Moist - 16) * 1.25) + @SpecWeight
            ELSE @SpecWeight
        END AS AdjSpec
)
SELECT 
    /* =====================================================================
       REGRADE (2024 + 2025 + FALLBACK)
       ===================================================================== */
    Regrade =
    CASE 

        /* ================================================================
           CROP YEAR 2025
           ================================================================ */
        WHEN @CropYear = 2025 THEN
        (
            CASE 
                -- TOP OVERRIDES
                WHEN @Commodity IN (
                    'LINSEED','OILSEED RAPE','PEAS','RYE',
                    'ORGANIC OATS','ORGANIC BEANS','ORGANIC MALTING BARLEY'
                ) 
                THEN @Variety 

                -- FEED BARLEY FIXED
                WHEN @Variety IN (
                    'BARLEY','BOLTON','CALIFORNIA','FEED BARLEY',
                    'KINGSBARN','KWS TARDIS','SY SPLENDOR','DIABLO',
                    'FDBLY','SKY','SKYWAY','PROPINO'
                ) THEN 'FEED BARLEY'

                -- MALTING BARLEY PREMIUM
                WHEN @Variety IN ('CRAFT','LAUREATE','PLANET','LAU','PLA')
                     AND @HAG >= 96 AND @PON <= 1.95 
                THEN @Variety

                -- MALTING BARLEY FEED
                WHEN @Variety IN ('CRAFT','LAUREATE','PLANET','LAU','PLA')
                     AND (NOT(@HAG >=96) OR NOT(@PON <=1.95))
                THEN 'FEED BARLEY'

                -- WARBURTONS MILLING
                WHEN @Variety IN (
                    'WARBURTONS CRUSOE','WARBURTONS ILLUSTRIOUS',
                    'WARBURTONS SKYFALL','WARBURTONS PALLADIUM',
                    'WARBURTONS ILLUST','WARBURTONS LOXTON'
                ) AND @PON >= 11.5 
                THEN 'WARBURTONS MILLING WHEAT'

                -- WARBURTONS GROUP 4 HARD
                WHEN @Variety IN (
                    'WARBURTONS CRUSOE','WARBURTONS ILLUSTRIOUS',
                    'WARBURTONS SKYFALL','WARBURTONS PALLADIUM',
                    'WARBURTONS ILLUST','WARBURTONS LOXTON'
                )
                     AND @PON >= 10.5 AND @PON < 11.5
                     AND (SELECT AdjSpec FROM adj) >= 72
                THEN 'GROUP 4 HARD'

                -- WARBURTONS FEED
                WHEN @Variety IN (
                    'WARBURTONS CRUSOE','WARBURTONS ILLUSTRIOUS',
                    'WARBURTONS SKYFALL','WARBURTONS PALLADIUM',
                    'WARBURTONS ILLUST','WARBURTONS LOXTON'
                )
                     AND (@PON < 10.5 OR (SELECT AdjSpec FROM adj) < 72)
                THEN 'FEED WHEAT'

                -- GROUP 1 MILLING (>=12)
                WHEN @Variety IN (
                    'CRUSOE','GROUP 1','ILLUSTRIOUS','MULIKA','SKYFALL',
                    'ZYATT','LADUM','CHEER','GP1M','NELSON'
                ) AND @PON >= 12 THEN 'GROUP 1 MILLING'

                -- GROUP 1 LOW GRADE (11–12)
                WHEN @Variety IN (
                    'CRUSOE','GROUP 1','ILLUSTRIOUS','MULIKA','SKYFALL',
                    'ZYATT','LADUM','CHEER','GP1M','NELSON'
                ) AND @PON >= 11 AND @PON < 12
                THEN 'LOW GRADE MILLING'

                -- GROUP 1 → GROUP 4 HARD
                WHEN @Variety IN (
                    'CRUSOE','GROUP 1','ILLUSTRIOUS','MULIKA','SKYFALL',
                    'ZYATT','LADUM','CHEER','GP1M','NELSON'
                )
                     AND @PON >= 10.5 AND @PON < 11
                     AND (SELECT AdjSpec FROM adj) >= 72
                THEN 'GROUP 4 HARD'

                -- GROUP 1 FEED
                WHEN @Variety IN (
                    'CRUSOE','GROUP 1','ILLUSTRIOUS','MULIKA','SKYFALL',
                    'ZYATT','LADUM','CHEER','GP1M','NELSON'
                )
                     AND (@PON <10.5 OR (SELECT AdjSpec FROM adj) < 72)
                THEN 'FEED WHEAT'

                -- GROUP 2 MILLING
                WHEN @Variety IN (
                    'COCHISE','EXTASE','PALLADIUM','SISKIN','CORDIALE',
                    'GROUP 2','MAYFLOWER','ALICIUM'
                ) AND @PON >= 12
                THEN 'GROUP 2 MILLING'

                -- GROUP 2 LOW GRADE
                WHEN @Variety IN (
                    'COCHISE','EXTASE','PALLADIUM','SISKIN','CORDIALE',
                    'GROUP 2','MAYFLOWER','ALICIUM'
                ) AND @PON >= 11 AND @PON < 12
                THEN 'LOW GRADE MILLING'

                -- GROUP 2 → GROUP 4 HARD
                WHEN @Variety IN (
                    'COCHISE','EXTASE','PALLADIUM','SISKIN','CORDIALE',
                    'GROUP 2','MAYFLOWER','ALICIUM'
                ) AND @PON >= 10.5 AND @PON < 11
                     AND (SELECT AdjSpec FROM adj) >= 72
                THEN 'GROUP 4 HARD'

                -- GROUP 2 FEED
                WHEN @Variety IN (
                    'COCHISE','EXTASE','PALLADIUM','SISKIN','CORDIALE',
                    'GROUP 2','MAYFLOWER','ALICIUM'
                )
                     AND (@PON <10.5 OR (SELECT AdjSpec FROM adj) < 72)
                THEN 'FEED WHEAT'

                -- CLEANED WHEAT (DAWSUM/GLEAM)
                WHEN @Variety IN ('DAWSUM WHEAT','GLEAM')
                     AND @PON >= 10
                     AND (SELECT AdjSpec FROM adj) >= 73
                THEN 'CLEANED WHEAT'

                WHEN @Variety IN ('DAWSUM WHEAT','GLEAM')
                     AND (@PON <10 OR (SELECT AdjSpec FROM adj) < 73)
                THEN 'FEED WHEAT'

                -- GROUP 4 HARD – GENERAL
                WHEN @Variety IN (
                    'GROUP 4 HARD','CHAMPION','CRANIUM','GRAHAM','INSITOR',
                    'SARTORIAL','TYPHOON','BEOWULF','COSTELLO','SKYSCRAPER'
                )
                     AND @PON >= 10.5
                     AND (SELECT AdjSpec FROM adj) >= 72
                THEN 'GROUP 4 HARD'

                WHEN @Variety IN (
                    'GROUP 4 HARD','CHAMPION','CRANIUM','GRAHAM','INSITOR',
                    'SARTORIAL','TYPHOON','BEOWULF','COSTELLO','SKYSCRAPER'
                )
                     AND (@PON <10.5 OR (SELECT AdjSpec FROM adj) < 72)
                THEN 'FEED WHEAT'

                -- SOFT WHEAT
                WHEN @Variety IN (
                    'GROUP 3 SOFT','GROUP 4 SOFT','ELICIT','FIREFLY',
                    'BAMFORD','GP3S','SAKI'
                )
                     AND @PON >= 9.8
                     AND (SELECT AdjSpec FROM adj) >= 72
                THEN 'SOFT WHEAT'

                WHEN @Variety IN (
                    'GROUP 3 SOFT','GROUP 4 SOFT','ELICIT','FIREFLY',
                    'BAMFORD','GP3S','SAKI'
                )
                     AND (@PON <9.8 OR (SELECT AdjSpec FROM adj) < 72)
                THEN 'FEED WHEAT'

                -- FEED WHEAT fixed
                WHEN @Variety IN ('FEED WHEAT','FDWHT')
                THEN 'FEED WHEAT'

                -- ORGANIC
                WHEN @Variety IN ('OG CRUSOE','OG MULIKA','OG EXTASE')
                     AND @PON >= 10
                THEN 'ORGANIC GROUP 1 MILLING'

                WHEN @Variety IN ('OG CRUSOE','OG MULIKA','OG EXTASE')
                     AND @PON < 10
                THEN 'ORGANIC FEED WHEAT'

                WHEN @Variety = 'OG FEED WHEAT'
                THEN 'ORGANIC FEED WHEAT'

                -- OATS
                WHEN @Variety IN (
                    'CANYON','ELYANN','ISABEL','LION','MERLIN',
                    'MILLING OATS','OATS','SPRING OATS'
                )
                THEN 'SPRING OATS'

                WHEN @Variety = 'MASCANI'
                THEN 'WINTER OATS'

                -- FIELD BEANS
                WHEN @Variety IN ('FUEGO','SPRING BEANS','LYNX','VERTIGO')
                THEN 'FIELD BEANS'

                WHEN @Variety IN ('BUMBLE','VESPA','TUNDRA','BEANS','BNS')
                     AND @HAG <= 10
                THEN 'WINTER BEANS'

                WHEN @Variety IN ('BUMBLE','VESPA','TUNDRA','BEANS','BNS')
                     AND @HAG > 10
                THEN 'FIELD BEANS'

                ELSE 'XXXX'
            END
        )  -- END 2025 BLOCK



        /* ================================================================
           CROP YEAR 2024
           ================================================================ */
        WHEN @CropYear = 2024 THEN
        (
            CASE 
                WHEN @Commodity IN (
                    'BEANS','LINSEED','OILSEED RAPE','PEAS','RYE',
                    'OATS','ORGANIC OATS','ORGANIC WHEAT'
                )
                THEN @Variety

                -- FEED BARLEY
                WHEN @Variety IN (
                    'ANY UNSPECIFIED BARLEY','BAZOOKA BARLEY',
                    'BOLTON WINTER BARLEY','CALIFORNIA BARLEY',
                    'FEED BARLEY','KINGSBARN BARLEY',
                    'KWS TARDIS WINTER BARLEY','MEMENTO BARLEY',
                    'ORWELL BARLEY','SY SPLENDOR BARLEY'
                ) THEN 'FEED BARLEY'

                -- MALTING BARLEY PREMIUM
                WHEN @Variety IN (
                    'CRAFT BARLEY','DIABLO BARLEY','ELECTRUM BARLEY',
                    'LAUREATE BARLEY','PLANET BARLEY','PROPINO BARLEY',
                    'SKYWAY BARLEY'
                ) AND @HAG >=96
                THEN @Variety

                -- MALTING BARLEY FEED
                WHEN @Variety IN (
                    'CRAFT BARLEY','DIABLO BARLEY','ELECTRUM BARLEY',
                    'LAUREATE BARLEY','PLANET BARLEY','PROPINO BARLEY',
                    'SKYWAY BARLEY'
                ) AND @HAG <96
                THEN 'FEED BARLEY'

                -- ORGANIC BARLEY PREMIUM
                WHEN @Variety IN (
                    'ORGANIC WESTMINSTER BARLEY','ORGANIC LAUREATE BARLEY'
                ) AND @HAG >=96
                THEN @Variety

                -- ORGANIC BARLEY FEED
                WHEN @Variety IN (
                    'ORGANIC WESTMINSTER BARLEY','ORGANIC LAUREATE BARLEY'
                ) AND @HAG <96
                THEN 'ORGANIC FEED BARLEY'

                -- WARBURTONS MILLING (>=11.5)
                WHEN @Variety IN (
                    'WARBURTONS CRUSOE WHEAT',
                    'WARBURTONS ILLUSTRIOUS WHEAT',
                    'WARBURTONS SKYFALL WHEAT'
                ) AND @PON >= 11.5
                THEN 'WARBURTONS MILLING WHEAT'

                -- WARBURTONS HARD (>=10 AND <11.5 AND AdjSpec >=72)
                WHEN @Variety IN (
                    'WARBURTONS CRUSOE WHEAT',
                    'WARBURTONS ILLUSTRIOUS WHEAT',
                    'WARBURTONS SKYFALL WHEAT'
                )
                     AND @PON >=10 AND @PON < 11.5
                     AND (SELECT AdjSpec FROM adj) >=72
                THEN 'GROUP 4 HARD'

                -- WARBURTONS FEED
                WHEN @Variety IN (
                    'WARBURTONS CRUSOE WHEAT',
                    'WARBURTONS ILLUSTRIOUS WHEAT',
                    'WARBURTONS SKYFALL WHEAT'
                )
                     AND (@PON <10 OR (SELECT AdjSpec FROM adj) <72)
                THEN 'FEED WHEAT'

                -- GROUP 1 MILLING (>=12)
                WHEN @Variety IN (
                    'ANY GROUP 1 WHEAT','CRUSOE WHEAT','GROUP 1 MILLING',
                    'ILLUSTRIOUS WHEAT','MULIKA WHEAT','SKYFALL WHEAT',
                    'ZYATT WHEAT','LADUM WHEAT'
                ) AND @PON >=12
                THEN 'GROUP 1 MILLING'

                -- LOW GRADE MILLING (>=11.5 <12)
                WHEN @Variety IN (
                    'ANY GROUP 1 WHEAT','CRUSOE WHEAT','GROUP 1 MILLING',
                    'ILLUSTRIOUS WHEAT','MULIKA WHEAT','SKYFALL WHEAT',
                    'ZYATT WHEAT','LADUM WHEAT'
                ) AND @PON >=11.5 AND @PON <12
                THEN 'LOW GRADE MILLING'

                -- GROUP 4 HARD (>=10 <11.5 AND AdjSpec >=72)
                WHEN @Variety IN (
                    'ANY GROUP 1 WHEAT','CRUSOE WHEAT','GROUP 1 MILLING',
                    'ILLUSTRIOUS WHEAT','MULIKA WHEAT','SKYFALL WHEAT',
                    'ZYATT WHEAT','LADUM WHEAT'
                )
                     AND @PON >=10 AND @PON <11.5
                     AND (SELECT AdjSpec FROM adj) >=72
                THEN 'GROUP 4 HARD'

                -- GROUP 1 FEED
                WHEN @Variety IN (
                    'ANY GROUP 1 WHEAT','CRUSOE WHEAT','GROUP 1 MILLING',
                    'ILLUSTRIOUS WHEAT','MULIKA WHEAT','SKYFALL WHEAT',
                    'ZYATT WHEAT','LADUM WHEAT'
                )
                     AND (@PON <10 OR (SELECT AdjSpec FROM adj) <72)
                THEN 'FEED WHEAT'

                -- GROUP 2 MILLING (>=12)
                WHEN @Variety IN (
                    'ANY GROUP 2 WHEAT','COCHISE WHEAT','EXTASE WHEAT',
                    'PALLADIUM WHEAT','SISKIN WHEAT','TYBALT WHEAT'
                ) AND @PON >=12
                THEN 'GROUP 2 MILLING'

                -- LOW GRADE MILLING (>=11.5 <12)
                WHEN @Variety IN (
                    'ANY GROUP 2 WHEAT','COCHISE WHEAT','EXTASE WHEAT',
                    'PALLADIUM WHEAT','SISKIN WHEAT','TYBALT WHEAT'
                ) AND @PON >=11.5 AND @PON <12
                THEN 'LOW GRADE MILLING'

                -- GROUP 4 HARD (>=10 <11.5 AND AdjSpec >=72)
                WHEN @Variety IN (
                    'ANY GROUP 2 WHEAT','COCHISE WHEAT','EXTASE WHEAT',
                    'PALLADIUM WHEAT','SISKIN WHEAT','TYBALT WHEAT'
                ) AND @PON >=10 AND @PON <11.5
                     AND (SELECT AdjSpec FROM adj) >=72
                THEN 'GROUP 4 HARD'

                -- GROUP 2 FEED
                WHEN @Variety IN (
                    'ANY GROUP 2 WHEAT','COCHISE WHEAT','EXTASE WHEAT',
                    'PALLADIUM WHEAT','SISKIN WHEAT','TYBALT WHEAT'
                )
                     AND (@PON <10 OR (SELECT AdjSpec FROM adj) <72)
                THEN 'FEED WHEAT'

                -- CLEANED WHEAT (DAWSUM/GLEAM/COSTELLO)
                WHEN @Variety IN (
                    'DAWSUM WHEAT - WITH GLYPHOSATE',
                    'GLEAM WHEAT','KWS DAWSUM WHEAT',
                    'COSTELLO WHEAT','COSTELLO WHEAT - WITH GLYPHOSATE',
                    'GLEAM WHEAT - WITH GLYPHOSATE'
                ) AND @PON >=10 AND (SELECT AdjSpec FROM adj) >=70
                THEN 'CLEANED WHEAT'

                WHEN @Variety IN (
                    'DAWSUM WHEAT - WITH GLYPHOSATE',
                    'GLEAM WHEAT','KWS DAWSUM WHEAT',
                    'COSTELLO WHEAT','COSTELLO WHEAT - WITH GLYPHOSATE',
                    'GLEAM WHEAT - WITH GLYPHOSATE'
                )
                     AND (@PON <10 OR (SELECT AdjSpec FROM adj) <70)
                THEN 'FEED WHEAT'

                -- GROUP 4 HARD GENERAL
                WHEN @Variety IN (
                    'ANY GROUP 4 HARD','CHAMPION WHEAT','CRANIUM WHEAT',
                    'GRAHAM WHEAT','INSITOR HYBRID WHEAT','SARTORIAL WHEAT',
                    'TYPHOON WHEAT'
                )
                     AND @PON >=10 AND (SELECT AdjSpec FROM adj) >=72
                THEN 'GROUP 4 HARD'

                WHEN @Variety IN (
                    'ANY GROUP 4 HARD','CHAMPION WHEAT','CRANIUM WHEAT',
                    'GRAHAM WHEAT','INSITOR HYBRID WHEAT','SARTORIAL WHEAT',
                    'TYPHOON WHEAT'
                )
                     AND (@PON <10 OR (SELECT AdjSpec FROM adj) <72)
                THEN 'FEED WHEAT'

                -- GROUP 3 SOFT
                WHEN @Variety IN (
                    'ANY GROUP 3 SOFT','ELICIT WHEAT','FIREFLY WHEAT'
                )
                     AND @PON >=9.5 AND (SELECT AdjSpec FROM adj) >=72
                THEN 'GROUP 3 SOFT'

                WHEN @Variety IN (
                    'ANY GROUP 3 SOFT','ELICIT WHEAT','FIREFLY WHEAT'
                )
                     AND (@PON <9.5 OR (SELECT AdjSpec FROM adj) <72)
                THEN 'FEED WHEAT'

                -- GROUP 4 SOFT
                WHEN @Variety IN (
                    'ANY GROUP 4 SOFT','GROUP 4 SOFT','SKYSCRAPER WHEAT'
                )
                     AND @PON >=9.5 AND (SELECT AdjSpec FROM adj) >=72
                THEN 'GROUP 4 SOFT'

                WHEN @Variety IN (
                    'ANY GROUP 4 SOFT','GROUP 4 SOFT','SKYSCRAPER WHEAT'
                )
                     AND (@PON <9.5 OR (SELECT AdjSpec FROM adj) <72)
                THEN 'FEED WHEAT'

                -- FIXED FEED WHEAT
                WHEN @Variety = 'FEED WHEAT'
                THEN 'FEED WHEAT'

                ELSE 'XXXX'
            END
        ) -- END 2024 BLOCK




        /* ================================================================
           FALLBACK FOR ALL OTHER YEARS
           ================================================================ */
        ELSE @Variety

    END, -- END Regrade



    /* =====================================================================
       REGRADED COMMODITY (2024 + 2025 + FALLBACK)
       ===================================================================== */
    RegradedCommodity =
    CASE 

        WHEN @CropYear = 2025 THEN
            CASE 
                WHEN @Variety IN (
                    'CRAFT','LAUREATE','PLANET','PLA','LAU'
                ) AND (NOT(@HAG >=96) OR NOT(@PON <=1.95))
                THEN 'FEED BARLEY'
                ELSE @Commodity
            END

        WHEN @CropYear = 2024 THEN
            CASE 
                WHEN @Variety IN (
                    'CRAFT BARLEY','DIABLO BARLEY','ELECTRUM BARLEY',
                    'LAUREATE BARLEY','PLANET BARLEY','PROPINO BARLEY',
                    'SKYWAY BARLEY'
                )
                AND @HAG < 96
                THEN 'FEED BARLEY'
                ELSE @Commodity
            END

        ELSE @Commodity

    END;
GO


